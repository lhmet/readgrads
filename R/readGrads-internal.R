.convertToLower <-
function(content) {
  return(sapply(content, tolower, USE.NAMES=FALSE))
}

.findLineForParam <-
function(cont, param, value = FALSE) {
  return(grep(param, cont, value = value))
}

.findNextLineStartingWithCharacter <-
function(cont, startnum) {
  for(i in (startnum+1):length(cont)) {
    if(grepl("^[A-Za-z*]+", cont[i])) break
  }
  return(i - 1)
}

.generateGradsMetadata <-
function(ctlparams) {
  gridsize = ctlparams$xdef$noLevels * ctlparams$ydef$noLevels
  return(data.frame(variable = rep(names(ctlparams$variables), each = gridsize * ctlparams$zdef$noLevels),
                    level = rep(ctlparams$zdef$levelValues, each = gridsize, times = ctlparams$vars)))
}

.getXYcoordinates <-
function(ctlparams) {
  return(data.frame(x = rep(ctlparams$xdef$levelValues, ctlparams$ydef$noLevels), 
                    y = rep(ctlparams$ydef$levelValues, each = ctlparams$xdef$noLevels)))
  
}

.mapGradsDataIndexToMetadata <-
function(ts, lev, var, ctlparams) {
  tstep =0; variable=0; level=0 # This line is present to avoid a 'note' when running R CMD check
  gradsIndex2metadata = data.frame(tstep = rep(1:ctlparams$tdef, each = ctlparams$zdef$noLevels * ctlparams$vars),
                                   variable = rep(names(ctlparams$variables), each = ctlparams$zdef$noLevels, times = ctlparams$tdef),
                                   level = rep(ctlparams$zdef$levelValues, times = ctlparams$vars * ctlparams$tdef))
  subsetMetadata = subset(gradsIndex2metadata, tstep %in% ts & variable %in% var & level %in% lev )
  indicies = as.numeric(rownames(subsetMetadata))
  return(list(indicies = indicies, metadata = subsetMetadata))
}

.parseLevelsCoordinateCTLline <-
function(s) {
  splitstring = .removeEmptySplitItems(strsplit(s, " ")[[1]])
  out = list(list(noLevels = as.numeric(splitstring[2]), 
    levelValues = as.numeric(splitstring[4:length(splitstring)])))
  names(out) = splitstring[1]
  return(out)
}

.parseSimpleCoordinateCTLline <-
function(s) {
  splitstring = .removeEmptySplitItems(strsplit(s, " ")[[1]])
  out = list(list(noLevels = as.numeric(splitstring[2]), 
                  levelValues = as.numeric(splitstring[4]) + ((0:(as.numeric(splitstring[2]) - 1)) * as.numeric(splitstring[5]))))
  names(out) = splitstring[1]
  return(out)
}

.parseSimpleCTLline <-
function(s, skipFinal = 0) {
  splitstring = .removeEmptySplitItems(strsplit(s, " ")[[1]])
  return(paste(splitstring[2:(length(splitstring) - skipFinal)], collapse = " "))
}

.parseVariableCTLline <-
function(s) {
  splitstring = .removeEmptySplitItems(strsplit(s, " ")[[1]])
  varLongNameUnit = paste(grep("^[A-za-z]+", splitstring[2:length(splitstring)], value = TRUE), collapse = " ")
  out = list(list(noVertLevels = as.numeric(splitstring[2]), varLongNameUnit = varLongNameUnit))
  names(out) = splitstring[1]
  return(out)
}

.Random.seed <-
c(403L, 1L, -1923643827L, 1473509860L, -236694582L, -6597067L, 
2109242511L, 1814648214L, 19032384L, -1594530813L, -820210143L, 
335806736L, -581177618L, 1532891801L, -2007471317L, -274680294L, 
1904270556L, 660754655L, 1636990645L, 294352972L, 598607010L, 
1303843837L, -256749321L, -1749944802L, 1369868504L, -30081989L, 
1286899161L, 503554920L, -1444786538L, 291760145L, -1585395261L, 
-1195346478L, 1405959268L, -1787442265L, -689052419L, -1529708300L, 
-1372784678L, -1097979099L, 323762751L, -1663237690L, -1848297904L, 
-683406733L, 997977745L, -892930368L, 867688606L, 1138134121L, 
663394459L, 25598378L, 1528136140L, 101706895L, -70196027L, -1284316036L, 
-859809582L, 1455847501L, 2041622791L, -2142370578L, 1247784392L, 
383750859L, 351492905L, -1176667272L, -163872602L, -2085324095L, 
-1132401837L, 1724585986L, -592890572L, -329138505L, -720969043L, 
1344385988L, -2003248150L, 1536746581L, 420198895L, -536534538L, 
1151858464L, -908285725L, -507380351L, -46343184L, -1584381298L, 
1952036345L, -938350709L, 419853242L, -1484453188L, -238304769L, 
197775189L, -1741944724L, -1798505278L, 1522210589L, -873771625L, 
1591471358L, 2069247672L, 316721307L, 1240721145L, -1079465912L, 
373201782L, -365838671L, -1395527965L, -234635854L, -294672892L, 
-751821497L, -1419061219L, 1297317524L, -811321798L, -824452987L, 
1415925087L, 424191462L, 1253104752L, -207356013L, 412932145L, 
1568020192L, 1992613758L, 1739118089L, -378175941L, 436461578L, 
-820002836L, 95466607L, 1245186981L, -1076319396L, 230209330L, 
-1538849235L, 1588268263L, -858120690L, 1731666920L, -127042069L, 
-1774147959L, -2135271912L, 116759878L, 218741665L, -1326516685L, 
-1250939998L, 638606996L, -871580393L, -1995609331L, 1227635236L, 
-1971232246L, -1129120907L, -1619157297L, -335957546L, 687037824L, 
525522371L, 1900442465L, -236697136L, 438649134L, -212424487L, 
2128618219L, -1666486438L, 819517724L, 205451295L, 74095733L, 
51136780L, -778320670L, 556633533L, -296224201L, -783185698L, 
-1452284904L, 107199355L, 1454975769L, -1145415768L, -1051281578L, 
-266244143L, -1651217533L, -790508014L, -193500764L, -127955609L, 
-1359990083L, -1636601292L, -186668646L, -121874971L, 1210675583L, 
377788678L, -1226276208L, -1232649421L, 600873169L, -1566188928L, 
-2103071906L, 447510697L, 875371355L, -1842017942L, -654705652L, 
781982799L, 1291488517L, 1169141180L, -1884960622L, 743877517L, 
877726663L, 547082414L, 1279320328L, 1295007499L, -1349072407L, 
88624824L, 374298982L, -1958798847L, 349279379L, 1747332930L, 
-550395660L, 461020407L, -461990675L, 2114430852L, -871786070L, 
860880661L, 1194515887L, 1968563638L, 1287814112L, 910807843L, 
-212741055L, 1766049584L, -294918834L, -325523527L, -1821924917L, 
112591482L, -969160836L, -1225586753L, -216739691L, -626991444L, 
-415896446L, -640132003L, -526433449L, 1337491006L, 345879160L, 
-1046060709L, -345919303L, 661954824L, 1460827062L, 615346417L, 
1988839203L, 1846002034L, 130667460L, 348823431L, 1957504349L, 
-1219536044L, 932061562L, -2091414982L, -839364752L, -1588786116L, 
2011476756L, 475280834L, -971145504L, 1983622012L, 1229210320L, 
-2007704414L, -970727384L, -256952052L, -775947332L, -1389286094L, 
1700618688L, 1766103604L, -305893432L, 239905978L, -257674864L, 
453317100L, -1294162348L, -1162169198L, 799294240L, 315433420L, 
987506144L, 2008635074L, -1745979352L, -265320788L, -314240836L, 
-1984913934L, 1457663280L, 1353295012L, 1617783480L, -43476646L, 
590621072L, -1684514948L, 1777699092L, 776404802L, 1995558656L, 
-580062276L, 1810940752L, 2137517858L, 1811428680L, 159034892L, 
-886478756L, 1623453906L, -1596776960L, 251552084L, -135934488L, 
-346199046L, 1788525776L, -2070161108L, -1760545036L, 1112792466L, 
930099296L, 15611148L, -1570084128L, 315559266L, 69739176L, -1694274996L, 
534197628L, -1370035918L, -1977844624L, -903959740L, 401375704L, 
-1443470214L, -1016928720L, -1240603972L, -1473375404L, 854581314L, 
1629161888L, 1288132284L, 1877364176L, -564548254L, 499329000L, 
-1490657332L, -1849507076L, -2092546574L, -1427571584L, -1409263372L, 
972814984L, 1053698874L, 58603344L, -545539476L, -1262761836L, 
-447463086L, -1464113440L, 123885260L, -1264363360L, 1766496130L, 
907937512L, 947191532L, 1299128380L, -1786894734L, 210302064L, 
-14820828L, 253995064L, -1863847910L, -1757174064L, -1345119172L, 
558341268L, 786450562L, -470876224L, 357206332L, 1304192656L, 
1008066594L, -172787704L, 44014732L, -1378167780L, -295007598L, 
-1951936384L, -1142741996L, -1030457048L, 1671551546L, 1470166224L, 
257086572L, 1565847220L, 789366802L, 1486653408L, 1876370380L, 
450903520L, -1106148830L, 1429269800L, 1817945356L, -357966276L, 
-442019598L, 1548472048L, 739340100L, 1363705432L, -810939846L, 
-452251920L, -1408823108L, 92885524L, -1517988670L, 393770080L, 
1468120444L, -2093182768L, 1929167906L, 1207623336L, 642614156L, 
506858940L, 1758362674L, 2036868928L, 862282932L, -1978915000L, 
1692781242L, -1425735920L, -709157652L, -378108844L, -134320366L, 
920483744L, -19950644L, -704466080L, 913720514L, 1545033256L, 
-2025400916L, 2050370364L, -1178863758L, 199268144L, -1195846108L, 
801301560L, -847576870L, 2098615696L, -2060403972L, 1382044564L, 
1298323266L, -1261560320L, -1101085124L, 798116432L, 807949986L, 
1417757512L, -1355861492L, -1733084964L, 774109778L, 1264390272L, 
-2016588972L, -1773476376L, 1053753082L, -1924871344L, -1272746964L, 
-1867282060L, 897676946L, -1103770016L, 1226909324L, -1714751648L, 
-610886942L, -1480200024L, 1817427148L, 876618236L, 2117877682L, 
-334681616L, -1015315004L, -771679400L, -1712189574L, -1113500240L, 
-1244359236L, -1309506476L, 1891321794L, -64461024L, 1601371068L, 
-730458544L, -2124502558L, -1390373528L, -1039717044L, 349574396L, 
-1456809230L, -986176768L, -1560916364L, 1584370696L, -272500294L, 
290468816L, -1938676244L, 401870740L, -1414054190L, -303986080L, 
1905417548L, 1957880096L, -1697743230L, -1157614104L, 1097708524L, 
-53585348L, 1115985522L, -124531856L, 1997910308L, -106782152L, 
292731290L, 629820880L, 2096266684L, 2051891819L, -129570323L, 
1727780954L, 1504257816L, -1645433727L, -422069709L, -1140701100L, 
2063535202L, 804479735L, -497693375L, 1241398214L, -1236547324L, 
1676568757L, 568334239L, -1856653320L, -967562794L, -344870813L, 
-333863899L, -1204964414L, -1924511568L, 659612889L, 537764427L, 
-953982788L, 2050545386L, -1542863073L, -2016643159L, 1555546430L, 
-709400532L, 845280893L, 84547783L, -133769808L, 697593806L, 
54949115L, 1254286173L, 1864968330L, 1972172456L, -808609263L, 
2114415363L, 331103748L, 2144529970L, -278851961L, 1743569617L, 
-461106090L, -1187128268L, -437321915L, -722844273L, -1059764984L, 
-1654008026L, 2014197715L, 151091509L, 792490130L, -2064453536L, 
-333847095L, 516603131L, -1446513972L, -695068838L, -857824689L, 
1368934169L, 2065150254L, 1194283836L, 1963292845L, -285861033L, 
219057824L, 965969918L, 1171459787L, -2023956275L, 1007035386L, 
-1341239240L, -750179871L, 407114387L, -1250772812L, 1537944002L, 
1936789975L, 930545185L, 2002351590L, -1822831388L, 1505195029L, 
-243522497L, 150645720L, 1436335606L, -216711677L, 1370569029L, 
669605218L, -496714032L, 476830201L, -384390869L, -1511173476L, 
-255510326L, -385306177L, 391697673L, -1289267682L, 1714752460L, 
2065090973L, 280675367L, 1995000400L, 1192883950L, 1703645083L, 
-1377567235L, 1156374762L, 812270472L, -1027281615L, -985737821L, 
-579223132L, 1565824082L, -188911705L, -900224015L, -949137610L, 
-483791916L, 1705836901L, -1698939537L, 1854554024L, -1982221050L, 
-1234060237L, 1958976149L, -2027443470L, 774640448L, -323438423L, 
1741892891L, -542491924L, 1278912250L, 621917999L, 1078048569L, 
-230954674L, -1440082020L, 1489663245L, 1061183351L, -1925727360L, 
1830777310L, 1537574571L, -1406998099L, 1241447962L, 1745289432L, 
997543233L, 997041651L, -197573612L, -1080276574L, -88170825L, 
1456945281L, -2082516858L, 1556038852L, -68935179L, 678607967L, 
-1927274824L, -1117286506L, -62257757L, -1084221083L, 373739650L, 
-470951440L, 1362726809L, 112290187L, 92304508L, -66871638L, 
-814737185L, 1185721961L, 1915518078L, 1691817068L, 156599485L, 
1126309255L, 1312504176L, 700709902L, 1629655355L, 217062941L, 
787849930L, 458083816L, -579185967L, -47051069L, 991962564L, 
1337152114L, -369300665L, -1960693583L)
.readCoordinateParam <-
function(cont, param) {
  linenum = .findLineForParam(cont, param, value = FALSE)
  if(grepl("levels", cont[linenum])) {
    endlinenum = .findNextLineStartingWithCharacter(cont, linenum)
    out = .parseLevelsCoordinateCTLline(paste(cont[linenum:endlinenum], collapse = " "))
  } else {
    out = .parseSimpleCoordinateCTLline(cont[linenum])
  }
  return(out)
}

.readSimpleParam <-
function(cont, param, toNumeric = FALSE, skipFinal = 0) {
  if(toNumeric) {
    out = list(as.numeric(.parseSimpleCTLline(.findLineForParam(cont, param, value = TRUE), skipFinal = skipFinal)))
  } else {
    out = list(.parseSimpleCTLline(.findLineForParam(cont, param, value = TRUE), skipFinal = skipFinal))
  }
  names(out) = param
  return(out)
}

.readVariablesParam <-
function(cont, noVars) {
  startVars = .findLineForParam(cont, "vars")[1] + 1
  varParams = sapply(startVars:(startVars + noVars - 1), function(x) .parseVariableCTLline(cont[x]))
  out = list(varParams)
  names(out) = "variables"
  return(out)
}

.removeEmptySplitItems <-
function(l) {
  emptyIndices = which(l == "")
  if(length(emptyIndices) > 0) return(l[-emptyIndices]) else return(l)
}

.stripLeadingWhiteSpaces <-
function(content) {
  return(sapply(content, function(x) sub('^[[:space:]]*', '', x), USE.NAMES=FALSE))
}

